syntax = "proto3";

package flowdeploy.v1;

option go_package = "github.com/paasdeploy/backend/gen/go/flowdeploy/v1;flowdeployv1";

import "google/protobuf/timestamp.proto";
import "flowdeploy/v1/deploy.proto";

message RegisterRequest {
  string agent_id = 1;
  string agent_version = 2;

  SystemInfo system_info = 3;
  DockerInfo docker_info = 4;
}

message RegisterResponse {
  bool accepted = 1;
  string message = 2;

  AgentConfig config = 3;

  repeated string pending_deployment_ids = 4;
}

message AgentConfig {
  int32 heartbeat_interval_seconds = 1;
  int32 log_buffer_size = 2;
  int32 max_concurrent_deploys = 3;

  bool enable_metrics = 4;
  bool enable_auto_update = 5;
}

message HeartbeatRequest {
  string agent_id = 1;
  google.protobuf.Timestamp timestamp = 2;

  AgentStatus status = 3;

  repeated ActiveDeployment active_deployments = 4;

  optional SystemMetrics metrics = 5;

  string agent_version = 6;

  optional string update_error = 7;
}

message AgentStatus {
  AgentState state = 1;
  int32 active_deploy_count = 2;
  int32 container_count = 3;

  google.protobuf.Timestamp started_at = 4;
  int64 uptime_seconds = 5;
}

enum AgentState {
  AGENT_STATE_UNSPECIFIED = 0;
  AGENT_STATE_IDLE = 1;
  AGENT_STATE_DEPLOYING = 2;
  AGENT_STATE_ERROR = 3;
  AGENT_STATE_UPDATING = 4;
}

message ActiveDeployment {
  string deployment_id = 1;
  string app_id = 2;
  DeployStage stage = 3;
  google.protobuf.Timestamp started_at = 4;
}

message HeartbeatResponse {
  bool acknowledged = 1;

  repeated AgentCommand commands = 2;

  optional AgentConfig updated_config = 3;
}

message AgentCommand {
  AgentCommandType type = 1;
  string payload = 2;
}

enum AgentCommandType {
  AGENT_COMMAND_UNSPECIFIED = 0;
  AGENT_COMMAND_DEPLOY = 1;
  AGENT_COMMAND_CANCEL_DEPLOY = 2;
  AGENT_COMMAND_RESTART_CONTAINER = 3;
  AGENT_COMMAND_UPDATE_AGENT = 4;
  AGENT_COMMAND_SHUTDOWN = 5;
}

message SystemInfo {
  string hostname = 1;
  string os = 2;
  string os_version = 3;
  string architecture = 4;

  int32 cpu_cores = 5;
  int64 memory_total_bytes = 6;
  int64 disk_total_bytes = 7;

  string kernel_version = 8;
}

message DockerInfo {
  string version = 1;
  string api_version = 2;

  string storage_driver = 3;
  int64 images_count = 4;
  int64 containers_count = 5;

  bool swarm_active = 6;
}

message SystemMetrics {
  double cpu_usage_percent = 1;
  int64 memory_used_bytes = 2;
  int64 memory_available_bytes = 3;
  int64 disk_used_bytes = 4;
  int64 disk_available_bytes = 5;

  double load_average_1m = 6;
  double load_average_5m = 7;
  double load_average_15m = 8;

  int64 network_rx_bytes = 9;
  int64 network_tx_bytes = 10;
}

message ListContainersRequest {
  bool all = 1;
  optional string app_id = 2;
}

message ListContainersResponse {
  repeated ContainerInfo containers = 1;
}

message ContainerInfo {
  string id = 1;
  string name = 2;
  string image = 3;
  string state = 4;
  string status = 5;

  google.protobuf.Timestamp created_at = 6;

  map<string, string> labels = 7;

  repeated PortBinding ports = 8;
}

message PortBinding {
  int32 container_port = 1;
  int32 host_port = 2;
  string protocol = 3;
}

message ContainerLogsRequest {
  string container_id = 1;
  bool follow = 2;
  int32 tail = 3;
  bool timestamps = 4;
  optional google.protobuf.Timestamp since = 5;
}

message ContainerLogEntry {
  google.protobuf.Timestamp timestamp = 1;
  string stream = 2;
  string message = 3;
}

message ContainerStatsRequest {
  string container_id = 1;
  bool stream = 2;
}

message ContainerStats {
  google.protobuf.Timestamp timestamp = 1;

  double cpu_percent = 2;
  int64 memory_usage_bytes = 3;
  int64 memory_limit_bytes = 4;

  int64 network_rx_bytes = 5;
  int64 network_tx_bytes = 6;

  int64 block_read_bytes = 7;
  int64 block_write_bytes = 8;
}

message RestartContainerRequest {
  string container_id = 1;
  int32 timeout_seconds = 2;
}

message RestartContainerResponse {
  bool success = 1;
  string message = 2;
}

message StopContainerRequest {
  string container_id = 1;
  int32 timeout_seconds = 2;
}

message StopContainerResponse {
  bool success = 1;
  string message = 2;
}

message StartContainerRequest {
  string container_id = 1;
}

message StartContainerResponse {
  bool success = 1;
  string message = 2;
}

message RemoveContainerRequest {
  string container_id = 1;
  bool force = 2;
}

message RemoveContainerResponse {
  bool success = 1;
  string message = 2;
}

message ListImagesRequest {
  bool all = 1;
}

message ListImagesResponse {
  repeated ImageInfo images = 1;
}

message ImageInfo {
  string id = 1;
  string repository = 2;
  string tag = 3;
  int64 size = 4;
  string created = 5;
  bool dangling = 6;
}

message RemoveImageRequest {
  string image_id = 1;
  bool force = 2;
}

message RemoveImageResponse {
  bool success = 1;
  string message = 2;
}

message PruneImagesRequest {}

message PruneImagesResponse {
  int32 images_removed = 1;
  int64 space_reclaimed_bytes = 2;
}

message ListNetworksRequest {}

message ListNetworksResponse {
  repeated NetworkInfo networks = 1;
}

message NetworkInfo {
  string name = 1;
}

message CreateNetworkRequest {
  string name = 1;
}

message CreateNetworkResponse {
  bool success = 1;
  string message = 2;
}

message RemoveNetworkRequest {
  string name = 1;
}

message RemoveNetworkResponse {
  bool success = 1;
  string message = 2;
}

message ListVolumesRequest {}

message ListVolumesResponse {
  repeated VolumeInfo volumes = 1;
}

message VolumeInfo {
  string name = 1;
}

message CreateVolumeRequest {
  string name = 1;
}

message CreateVolumeResponse {
  bool success = 1;
  string message = 2;
}

message RemoveVolumeRequest {
  string name = 1;
}

message RemoveVolumeResponse {
  bool success = 1;
  string message = 2;
}

message UpdateDomainsRequest {
  string app_id = 1;
  string app_name = 2;
  repeated DomainRouteConfig domains = 3;
  int32 port = 4;
  map<string, string> env_vars = 5;
}

message DomainRouteConfig {
  string domain = 1;
  string path_prefix = 2;
}

message UpdateDomainsResponse {
  bool success = 1;
  string message = 2;
}

message ExecInput {
  oneof payload {
    ExecStartRequest start = 1;
    bytes data = 2;
    ExecResize resize = 3;
  }
}

message ExecStartRequest {
  string container_id = 1;
  string shell = 2;
  uint32 cols = 3;
  uint32 rows = 4;
}

message ExecResize {
  uint32 cols = 1;
  uint32 rows = 2;
}

message ExecOutput {
  oneof payload {
    bytes data = 1;
    int32 exit_code = 2;
  }
}
