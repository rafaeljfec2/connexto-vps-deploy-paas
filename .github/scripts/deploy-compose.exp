#!/usr/bin/expect -f
set timeout 600

set user [string trim $env(SERVER_USER)]
set password [string trim $env(SERVER_PASSWORD)]
set host [string trim $env(SERVER_HOST)]
set port [string trim $env(SERVER_PORT)]
set deploy_path [string trim $env(DEPLOY_PATH)]

set postgres_user $env(POSTGRES_USER)
set postgres_password $env(POSTGRES_PASSWORD)
set postgres_db $env(POSTGRES_DB)

puts "ğŸš€ Deploying to $host:$port"

spawn ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -p $port $user@$host

expect {
  "yes/no" { send "yes\r"; exp_continue }
  "password:" { send "$password\r" }
  timeout { puts "âŒ Connection timeout"; exit 1 }
}

expect "$ "

puts "ğŸ“¥ Pulling latest code..."
send "cd $deploy_path && git fetch origin && git reset --hard origin/main\r"
expect "$ "

puts "ğŸ“ Creating .env file..."
send "cat > $deploy_path/deploy/.env << 'ENVEOF'\r"
expect ">"
send "POSTGRES_USER=$postgres_user\r"
expect ">"
send "POSTGRES_PASSWORD=$postgres_password\r"
expect ">"
send "POSTGRES_DB=$postgres_db\r"
expect ">"
send "ENVEOF\r"
expect "$ "

send "chmod 600 $deploy_path/deploy/.env\r"
expect "$ "

puts "ğŸ³ Creating Docker network..."
send "docker network create paasdeploy 2>/dev/null || true\r"
expect "$ "

puts "ğŸ”¨ Building and starting services..."
send "cd $deploy_path/deploy && docker compose --env-file .env up -d --build\r"
expect {
  "done" { puts "âœ… Services started" }
  "Started" { puts "âœ… Services started" }
  "Running" { puts "âœ… Services running" }
  timeout { puts "â³ Waiting for build..." }
}
expect "$ "

puts "ğŸ“‹ Checking container status..."
send "docker compose -f $deploy_path/deploy/docker-compose.yml ps\r"
expect "$ "

send "exit\r"
expect eof

puts "ğŸ‰ Deployment completed successfully!"
