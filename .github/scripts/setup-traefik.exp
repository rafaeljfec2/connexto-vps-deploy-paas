#!/usr/bin/expect -f
set timeout 300

set user [string trim $env(SERVER_USER)]
set password [string trim $env(SERVER_PASSWORD)]
set host [string trim $env(SERVER_HOST)]
set port [string trim $env(SERVER_PORT)]
set traefik_network [string trim $env(TRAEFIK_NETWORK)]
if {[info exists env(TRAEFIK_NETWORK_SECONDARY)]} {
  set traefik_network_secondary [string trim $env(TRAEFIK_NETWORK_SECONDARY)]
} else {
  set traefik_network_secondary ""
}
set letsencrypt_email [string trim $env(LETSENCRYPT_EMAIL)]

puts "ðŸ”§ Setting up Traefik on $host..."

spawn ssh -o StrictHostKeyChecking=no -p $port $user@$host

expect {
  "yes/no" { send "yes\r"; exp_continue }
  "password:" { send "$password\r" }
  timeout { puts "âŒ Connection timeout"; exit 1 }
}

expect "$ "

send "docker network create $traefik_network 2>/dev/null || true\r"
expect "$ "
if {$traefik_network_secondary != ""} {
  send "docker network create $traefik_network_secondary 2>/dev/null || true\r"
  expect "$ "
}

send "echo '$password' | sudo -S mkdir -p /opt/traefik/config /opt/traefik/letsencrypt 2>/dev/null\r"
expect "$ "

send "sudo tee /opt/traefik/traefik.yml > /dev/null << 'TRAEFIK_CONFIG'\r"
send "api:\r"
send "  dashboard: true\r"
send "  insecure: true\r"
send "\r"
send "entryPoints:\r"
send "  web:\r"
send "    address: \":80\"\r"
send "  websecure:\r"
send "    address: \":443\"\r"
send "  grpc:\r"
send "    address: \":50051\"\r"
send "  traefik:\r"
send "    address: \":8081\"\r"
send "\r"
send "providers:\r"
send "  docker:\r"
send "    endpoint: \"unix:///var/run/docker.sock\"\r"
send "    exposedByDefault: false\r"
send "    network: $traefik_network\r"
send "\r"
send "certificatesResolvers:\r"
send "  letsencrypt:\r"
send "    acme:\r"
send "      email: $letsencrypt_email\r"
send "      storage: /letsencrypt/acme.json\r"
send "      httpChallenge:\r"
send "        entryPoint: web\r"
send "\r"
send "log:\r"
send "  level: INFO\r"
send "TRAEFIK_CONFIG\r"
expect "$ "

send "docker stop traefik 2>/dev/null || true\r"
expect "$ "
send "docker rm traefik 2>/dev/null || true\r"
expect "$ "
puts "ðŸš€ Starting Traefik (80, 443, 50051, 8081)..."
send "docker run -d --name traefik --network $traefik_network --restart unless-stopped -p 80:80 -p 443:443 -p 50051:50051 -p 8081:8081 -v /var/run/docker.sock:/var/run/docker.sock:ro -v /opt/traefik/traefik.yml:/etc/traefik/traefik.yml:ro -v /opt/traefik/letsencrypt:/letsencrypt traefik:latest\r"
expect "$ "
if {$traefik_network_secondary != ""} {
  send "docker network connect $traefik_network_secondary traefik 2>/dev/null || true\r"
  expect "$ "
}

send "exit\r"
expect eof
