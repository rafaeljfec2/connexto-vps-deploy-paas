#!/usr/bin/expect -f
set timeout 300

set user [string trim $env(SERVER_USER)]
set password [string trim $env(SERVER_PASSWORD)]
set host [string trim $env(SERVER_HOST)]
set port [string trim $env(SERVER_PORT)]

set registry [string trim $env(REGISTRY)]
set image [string trim $env(IMAGE_NAME)]
set ghcr_user [string trim $env(GHCR_USER)]
set ghcr_pat [string trim $env(GHCR_PAT)]
set container_name [string trim $env(CONTAINER_NAME)]

set app_env [string trim $env(APP_ENV)]
set log_level [string trim $env(LOG_LEVEL)]
set database_url $env(DATABASE_URL)
set deploy_workers [string trim $env(DEPLOY_WORKERS)]
set deploy_timeout [string trim $env(DEPLOY_TIMEOUT)]
set health_check_timeout [string trim $env(HEALTH_CHECK_TIMEOUT)]
set health_check_retries [string trim $env(HEALTH_CHECK_RETRIES)]
set github_webhook_secret $env(GITHUB_WEBHOOK_SECRET)
set github_webhook_url $env(GITHUB_WEBHOOK_URL)
set github_client_id $env(GITHUB_CLIENT_ID)
set github_client_secret $env(GITHUB_CLIENT_SECRET)
set github_oauth_callback_url $env(GITHUB_OAUTH_CALLBACK_URL)
set github_app_id $env(GITHUB_APP_ID)
set github_app_private_key_base64 $env(GITHUB_APP_PRIVATE_KEY_BASE64)
set github_app_install_url $env(GITHUB_APP_INSTALL_URL)
set token_encryption_key $env(TOKEN_ENCRYPTION_KEY)
set frontend_url $env(FRONTEND_URL)
set cloudflare_server_ip [string trim $env(CLOUDFLARE_SERVER_IP)]
set api_domain [string trim $env(API_DOMAIN)]
set traefik_network [string trim $env(TRAEFIK_NETWORK)]

puts "ðŸš€ Starting deployment to $host:$port"
puts "ðŸ“¦ Image: $registry/$image:latest"

spawn ssh -o StrictHostKeyChecking=no -p $port $user@$host

expect {
  "yes/no" { send "yes\r"; exp_continue }
  "password:" { send "$password\r" }
  timeout { puts "âŒ Connection timeout"; exit 1 }
}

expect "$ "

send "docker login $registry -u $ghcr_user -p $ghcr_pat\r"
expect "Login Succeeded"
expect "$ "

send "docker pull $registry/$image:latest\r"
expect "$ "

send "docker network create $traefik_network 2>/dev/null || true\r"
expect "$ "

send "docker stop $container_name 2>/dev/null || true\r"
expect "$ "

send "docker rm $container_name 2>/dev/null || true\r"
expect "$ "

send "echo '$password' | sudo -S mkdir -p /opt/flowdeploy\r"
expect "$ "

send "echo '$github_app_private_key_base64' | base64 -d | sudo tee /opt/flowdeploy/github-app-private-key.pem > /dev/null\r"
expect "$ "

send "sudo chmod 600 /opt/flowdeploy/github-app-private-key.pem\r"
expect "$ "

# Create a deploy script on the server to avoid quoting issues
send "cat > /tmp/deploy-container.sh << 'DEPLOY_SCRIPT'\r"
send "#!/bin/bash\r"
send "docker run -d \\\\\r"
send "  --name $container_name \\\\\r"
send "  --network $traefik_network \\\\\r"
send "  --restart unless-stopped \\\\\r"
send "  -p 9005:8080 \\\\\r"
send "  -v /var/run/docker.sock:/var/run/docker.sock \\\\\r"
send "  -v /opt/flowdeploy:/opt/flowdeploy \\\\\r"
send "  -v flowdeploy-data:/data/apps \\\\\r"
send "  -e APP_ENV=$app_env \\\\\r"
send "  -e HOST=0.0.0.0 \\\\\r"
send "  -e PORT=8080 \\\\\r"
send "  -e LOG_LEVEL=$log_level \\\\\r"
send "  -e DATABASE_URL='$database_url' \\\\\r"
send "  -e DEPLOY_DATA_DIR=/data/apps \\\\\r"
send "  -e DEPLOY_WORKERS=$deploy_workers \\\\\r"
send "  -e DEPLOY_TIMEOUT=$deploy_timeout \\\\\r"
send "  -e HEALTH_CHECK_TIMEOUT=$health_check_timeout \\\\\r"
send "  -e HEALTH_CHECK_RETRIES=$health_check_retries \\\\\r"
send "  -e DOCKER_HOST=unix:///var/run/docker.sock \\\\\r"
send "  -e GIT_HUB_WEBHOOK_SECRET='$github_webhook_secret' \\\\\r"
send "  -e GIT_HUB_WEBHOOK_URL='$github_webhook_url' \\\\\r"
send "  -e GIT_HUB_CLIENT_ID='$github_client_id' \\\\\r"
send "  -e GIT_HUB_CLIENT_SECRET='$github_client_secret' \\\\\r"
send "  -e GIT_HUB_OAUTH_CALLBACK_URL='$github_oauth_callback_url' \\\\\r"
send "  -e GIT_HUB_APP_ID='$github_app_id' \\\\\r"
send "  -e GIT_HUB_APP_PRIVATE_KEY_PATH=/opt/flowdeploy/github-app-private-key.pem \\\\\r"
send "  -e GIT_HUB_APP_INSTALL_URL='$github_app_install_url' \\\\\r"
send "  -e TOKEN_ENCRYPTION_KEY='$token_encryption_key' \\\\\r"
send "  -e FRONTEND_URL='$frontend_url' \\\\\r"
if {[string length $cloudflare_server_ip] > 0} {
  send "  -e CLOUDFLARE_SERVER_IP='$cloudflare_server_ip' \\\\\r"
}
send "  --label traefik.enable=true \\\\\r"
send "  --label 'traefik.http.routers.$container_name.rule=Host(\`$api_domain\`)' \\\\\r"
send "  --label traefik.http.routers.$container_name.entrypoints=websecure \\\\\r"
send "  --label traefik.http.routers.$container_name.tls=true \\\\\r"
send "  --label traefik.http.routers.$container_name.tls.certresolver=letsencrypt \\\\\r"
send "  --label traefik.http.services.$container_name.loadbalancer.server.port=8080 \\\\\r"
send "  --label 'traefik.http.routers.$container_name-http.rule=Host(\`$api_domain\`)' \\\\\r"
send "  --label traefik.http.routers.$container_name-http.entrypoints=web \\\\\r"
send "  --label traefik.http.routers.$container_name-http.middlewares=redirect-to-https \\\\\r"
send "  --label traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https \\\\\r"
send "  $registry/$image:latest\r"
send "DEPLOY_SCRIPT\r"
expect "$ "

send "chmod +x /tmp/deploy-container.sh && /tmp/deploy-container.sh\r"
expect -re {([0-9a-f]{64}|[0-9a-f]{12})}
puts "âœ… Container started"
expect "$ "

send "docker ps --filter name=$container_name --format '{{.Status}}'\r"
expect "$ "

send "rm /tmp/deploy-container.sh\r"
expect "$ "

send "exit\r"
expect eof
