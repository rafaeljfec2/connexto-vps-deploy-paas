#!/usr/bin/expect -f
set timeout 600

set user [string trim $env(SERVER_USER)]
set password [string trim $env(SERVER_PASSWORD)]
set host [string trim $env(SERVER_HOST)]
set port [string trim $env(SERVER_PORT)]

set registry [string trim $env(REGISTRY)]
set image [string trim $env(IMAGE_NAME)]
set ghcr_user [string trim $env(GHCR_USER)]
set ghcr_pat [string trim $env(GHCR_PAT)]
set container_name [string trim $env(CONTAINER_NAME)]

set app_env [string trim $env(APP_ENV)]
set log_level [string trim $env(LOG_LEVEL)]
set database_url $env(DATABASE_URL)
set deploy_workers [string trim $env(DEPLOY_WORKERS)]
set deploy_timeout [string trim $env(DEPLOY_TIMEOUT)]
set health_check_timeout [string trim $env(HEALTH_CHECK_TIMEOUT)]
set health_check_retries [string trim $env(HEALTH_CHECK_RETRIES)]
set github_pat $env(GITHUB_PAT)
set github_webhook_secret $env(GITHUB_WEBHOOK_SECRET)
set github_webhook_url $env(GITHUB_WEBHOOK_URL)
set github_client_id $env(GITHUB_CLIENT_ID)
set github_client_secret $env(GITHUB_CLIENT_SECRET)
set github_oauth_callback_url $env(GITHUB_OAUTH_CALLBACK_URL)
set github_app_id $env(GITHUB_APP_ID)
set github_app_private_key_base64 $env(GITHUB_APP_PRIVATE_KEY_BASE64)
set github_app_install_url $env(GITHUB_APP_INSTALL_URL)
set token_encryption_key $env(TOKEN_ENCRYPTION_KEY)
set frontend_url $env(FRONTEND_URL)
set cloudflare_server_ip [string trim $env(CLOUDFLARE_SERVER_IP)]
set api_domain [string trim $env(API_DOMAIN)]
set traefik_network [string trim $env(TRAEFIK_NETWORK)]

puts "ğŸš€ Starting deployment to $host:$port"
puts "ğŸ“¦ Image: $registry/$image:latest"

spawn ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -p $port $user@$host

expect {
  "yes/no" { send "yes\r"; exp_continue }
  "password:" { send "$password\r" }
  timeout { puts "âŒ Connection timeout"; exit 1 }
}

expect "$ "

send "docker login $registry -u $ghcr_user -p $ghcr_pat\r"
expect "Login Succeeded"
expect "$ "

send "docker pull $registry/$image:latest\r"
expect "$ "

send "docker network create $traefik_network 2>/dev/null || true\r"
expect "$ "

send "docker stop $container_name 2>/dev/null || true\r"
expect "$ "

send "docker rm $container_name 2>/dev/null || true\r"
expect "$ "

send "echo '$password' | sudo -S mkdir -p /opt/flowdeploy 2>/dev/null\r"
expect "$ "

send "echo '$github_app_private_key_base64' | base64 -d | sudo tee /opt/flowdeploy/github-app-private-key.pem > /dev/null\r"
expect "$ "

send "sudo chmod 644 /opt/flowdeploy/github-app-private-key.pem\r"
expect "$ "

# Create Traefik labels file to avoid backtick escaping issues
send "echo 'traefik.enable=true' > /tmp/labels.txt\r"
expect "$ "
send "echo 'traefik.http.routers.$container_name.rule=Host(\`$api_domain\`)' >> /tmp/labels.txt\r"
expect "$ "
send "echo 'traefik.http.routers.$container_name.entrypoints=websecure' >> /tmp/labels.txt\r"
expect "$ "
send "echo 'traefik.http.routers.$container_name.tls=true' >> /tmp/labels.txt\r"
expect "$ "
send "echo 'traefik.http.routers.$container_name.tls.certresolver=letsencrypt' >> /tmp/labels.txt\r"
expect "$ "
send "echo 'traefik.http.services.$container_name.loadbalancer.server.port=8080' >> /tmp/labels.txt\r"
expect "$ "
send "echo 'traefik.http.routers.$container_name-http.rule=Host(\`$api_domain\`)' >> /tmp/labels.txt\r"
expect "$ "
send "echo 'traefik.http.routers.$container_name-http.entrypoints=web' >> /tmp/labels.txt\r"
expect "$ "
send "echo 'traefik.http.routers.$container_name-http.middlewares=redirect-to-https' >> /tmp/labels.txt\r"
expect "$ "
send "echo 'traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https' >> /tmp/labels.txt\r"
expect "$ "

# Build docker run command
set cmd "docker run -d"
append cmd " --name $container_name"
append cmd " --network $traefik_network"
append cmd " --restart unless-stopped"
append cmd " -p 9005:8080"
append cmd " -v /var/run/docker.sock:/var/run/docker.sock"
append cmd " -v /opt/flowdeploy:/opt/flowdeploy"
append cmd " -v flowdeploy-data:/data/apps"
append cmd " -e APP_ENV=$app_env"
append cmd " -e HOST=0.0.0.0"
append cmd " -e PORT=8080"
append cmd " -e LOG_LEVEL=$log_level"
append cmd " -e 'DATABASE_URL=$database_url'"
append cmd " -e DEPLOY_DATA_DIR=/data/apps"
append cmd " -e DEPLOY_WORKERS=$deploy_workers"
append cmd " -e DEPLOY_TIMEOUT=$deploy_timeout"
append cmd " -e HEALTH_CHECK_TIMEOUT=$health_check_timeout"
append cmd " -e HEALTH_CHECK_RETRIES=$health_check_retries"
append cmd " -e DOCKER_HOST=unix:///var/run/docker.sock"
append cmd " -e 'GIT_HUB_PAT=$github_pat'"
append cmd " -e 'GIT_HUB_WEBHOOK_SECRET=$github_webhook_secret'"
append cmd " -e 'GIT_HUB_WEBHOOK_URL=$github_webhook_url'"
append cmd " -e 'GIT_HUB_CLIENT_ID=$github_client_id'"
append cmd " -e 'GIT_HUB_CLIENT_SECRET=$github_client_secret'"
append cmd " -e 'GIT_HUB_OAUTH_CALLBACK_URL=$github_oauth_callback_url'"
append cmd " -e 'GIT_HUB_APP_ID=$github_app_id'"
append cmd " -e GIT_HUB_APP_PRIVATE_KEY_PATH=/opt/flowdeploy/github-app-private-key.pem"
append cmd " -e 'GIT_HUB_APP_INSTALL_URL=$github_app_install_url'"
append cmd " -e 'TOKEN_ENCRYPTION_KEY=$token_encryption_key'"
append cmd " -e 'FRONTEND_URL=$frontend_url'"

if {[string length $cloudflare_server_ip] > 0} {
  append cmd " -e 'CLOUDFLARE_SERVER_IP=$cloudflare_server_ip'"
}

append cmd " --label-file /tmp/labels.txt"
append cmd " $registry/$image:latest"

# Execute docker run
send "$cmd\r"

expect {
  -re {[0-9a-f]{64}} { puts "âœ… Container started successfully" }
  -re {[0-9a-f]{12}} { puts "âœ… Container started successfully" }
  "Error" { puts "âŒ Container failed to start"; exit 1 }
  timeout { puts "âŒ Timeout waiting for container"; exit 1 }
}
expect "$ "

send "docker ps --filter name=$container_name --format '{{.Status}}'\r"
expect "$ "

send "rm /tmp/labels.txt\r"
expect "$ "

send "exit\r"
expect eof

puts "ğŸ‰ Deployment completed successfully!"
